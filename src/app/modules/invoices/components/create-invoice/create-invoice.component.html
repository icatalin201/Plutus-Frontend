<div class="dialog-wrapper">

    <div class="inner-wrapper">
        <h1>Adauga factura
            <span *ngIf="serialName"> - {{serialName}}</span>
        </h1>

        <form [formGroup]="requestForm">
            <div formGroupName="invoice" class="flex row wrap">
                <mat-form-field appearance="fill" class="flex-5">
                    <mat-label>Client</mat-label>
                    <mat-select formControlName="partnerId" required>
                        <mat-option [value]="partner.id" 
                          (click)="onSelectPartner(partner)"
                          *ngFor="let partner of partners">
                          {{partner.name}}
                        </mat-option>
                    </mat-select>
                    <mat-error>Clientul este obligatoriu</mat-error>
                </mat-form-field>
                <mat-form-field appearance="fill" class="flex-5">
                  <mat-label>Moneda</mat-label>
                  <mat-select #currency formControlName="currency" required>
                      <mat-option value="RON">RON</mat-option>
                      <mat-option value="EUR">EUR</mat-option>
                      <mat-option value="USD">USD</mat-option>
                  </mat-select>
                  <mat-error>Alege o moneda</mat-error>
              </mat-form-field>
                <mat-form-field appearance="fill" class="flex-5">
                    <mat-label>Data</mat-label>
                    <input matInput required formControlName="date" [matDatepicker]="date" (dateChange)="onSelectDate($event)">
                    <mat-datepicker-toggle matSuffix [for]="date"></mat-datepicker-toggle>
                    <mat-datepicker #date></mat-datepicker>
                </mat-form-field>
                <mat-form-field appearance="fill" class="flex-5">
                    <mat-label>Data scadenta</mat-label>
                    <input matInput required formControlName="dueDate" [matDatepicker]="dueDate">
                    <mat-datepicker-toggle matSuffix [for]="dueDate"></mat-datepicker-toggle>
                    <mat-datepicker #dueDate></mat-datepicker>
                </mat-form-field>
                <div class="flex-10 pt-1 pb-1 flex row justify-between align-center">
                    Linii facturi
                    <button type="button" mat-button color="primary" (click)="addLine()">Adauga linie</button>
                </div>
                <div class="invoice-line-wrapper pb-2">
                  <table mat-table [dataSource]="lines">
                    <ng-container matColumnDef="item">
                      <th mat-header-cell *matHeaderCellDef> Serviciu </th>
                      <td mat-cell *matCellDef="let element"> {{element.item.name}} </td>
                      <td mat-footer-cell *matFooterCellDef> Total </td>
                    </ng-container>
                    <ng-container matColumnDef="price">
                      <th mat-header-cell *matHeaderCellDef> Pret </th>
                      <td mat-cell *matCellDef="let element"> {{currency.value}} {{element.price}} </td>
                      <td mat-footer-cell *matFooterCellDef> </td>
                    </ng-container>
                    <ng-container matColumnDef="quantity">
                      <th mat-header-cell *matHeaderCellDef> Cantitate </th>
                      <td mat-cell *matCellDef="let element"> {{element.quantity}} </td>
                      <td mat-footer-cell *matFooterCellDef> </td>
                    </ng-container>
                    <ng-container matColumnDef="uom">
                      <th mat-header-cell *matHeaderCellDef> Unitate de masura </th>
                      <td mat-cell *matCellDef="let element"> {{element.uom}} </td>
                      <td mat-footer-cell *matFooterCellDef> </td>
                    </ng-container>
                    <ng-container matColumnDef="vat">
                      <th mat-header-cell *matHeaderCellDef> TVA </th>
                      <td mat-cell *matCellDef="let element"> {{element.vat}} </td>
                      <td mat-footer-cell *matFooterCellDef> </td>
                    </ng-container>
                    <ng-container matColumnDef="subtotal">
                      <th mat-header-cell *matHeaderCellDef> Valoare </th>
                      <td mat-cell *matCellDef="let element"> {{currency.value}} {{(element.price * element.quantity).toFixed(2)}} </td>
                      <td mat-footer-cell *matFooterCellDef> </td>
                    </ng-container>
                    <ng-container matColumnDef="total">
                      <th mat-header-cell *matHeaderCellDef> Total </th>
                      <td mat-cell *matCellDef="let element"> {{currency.value}} {{(element.vat / 100 * (element.price * element.quantity) + (element.price * element.quantity)).toFixed(2)}} </td>
                      <td mat-footer-cell *matFooterCellDef> {{currency.value}} {{getTotalPrice()}} </td>
                    </ng-container>
                    <ng-container matColumnDef="actions">
                      <th mat-header-cell *matHeaderCellDef></th>
                      <td mat-cell *matCellDef="let element" style="text-align: right;"> 
                        <button mat-icon-button 
                          type="button"
                          color="warn" (click)="deleteLine(element)">
                          <mat-icon>delete</mat-icon>
                        </button>
                      </td>
                      <td mat-footer-cell *matFooterCellDef> </td>
                    </ng-container>
                    <tr mat-header-row *matHeaderRowDef="columnLinesToDisplay"></tr>
                    <tr mat-row *matRowDef="let row; columns: columnLinesToDisplay;"></tr>
                    <tr style="background-color: #262626;" mat-footer-row *matFooterRowDef="columnLinesToDisplay; sticky: true"></tr>
                  </table>
                </div>
            </div>
        </form>

        <div class="flex row justify-end">
          <button mat-button color="primary" (click)="create()" [disabled]="requestForm.invalid || loading">Adauga</button>
          <button mat-button color="warn" (click)="dismiss()">Anuleaza</button>
        </div>
    </div>

    <mat-progress-bar *ngIf="loading" mode="indeterminate"></mat-progress-bar>

</div>
